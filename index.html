<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>GLUT SGG</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fff; }
header { background:#e36c00; color:#fff; padding:0; text-align:center; position:relative; height:200px; overflow:hidden; }
header img { width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:0; opacity:0.8; }
header h1 { position:relative; z-index:1; font-size:28px; background:rgba(0,0,0,0.4); display:inline-block; padding:10px 20px; border-radius:8px; margin-top:70px; }
main { padding:20px; }
input[type="file"], button.loadDefault { margin-bottom:20px; padding:6px 12px; border:none; border-radius:4px; background:#e36c00; color:#fff; cursor:pointer; }
table { width:100%; border-collapse:collapse; font-family:monospace; table-layout:fixed; }
table, th, td { border:1px solid #000; }
th, td { padding:4px 8px; text-align:center; word-break:break-all; }
th { background:#f0f0f0; position:sticky; top:0; z-index:2; }
.pagination { margin-top:15px; text-align:center; }
.pagination button { padding:6px 12px; margin:0 5px; border:none; border-radius:4px; background:#e36c00; color:#fff; cursor:pointer; }
.pagination button:disabled { background:#ccc; cursor:not-allowed; }
</style>
</head>
<body>

<header>
  <img src="https://www.glut.edu.cn/images/yanshandamen.jpg" alt="glut">
  <h1>GLUT SGG</h1>
</header>

<main>
  <button class="loadDefault">显示库中默认文件数据</button>
  <input type="file" id="fileInput" accept=".csv,.txt">
  
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>
  
  <div class="pagination">
    <button id="prevBtn">上一页</button>
    <span id="pageInfo"></span>
    <button id="nextBtn">下一页</button>
  </div>
</main>

<script>
const fileInput = document.getElementById('fileInput');
const loadDefaultBtn = document.querySelector('.loadDefault');
const table = document.getElementById('dataTable');
const thead = table.querySelector('thead');
const tbody = table.querySelector('tbody');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');

let fullData = [];
let displayedData = [];
const rowsPerPage = 200;
let currentPage = 1;

// 中文 + 英文表头
const fixedHeaders = [
  '行号',
  '年 (year)', 
  '年积日 (doy)', 
  '日积时 (hour)', 
  '纬度 (lat)', 
  '经度 (lon)', 
  '天顶对流层干延迟 (ZHD)', 
  '天顶对流层湿延迟 (ZWD)', 
  '加权平均温度 (Tm)', 
  '大气可降雨量 (PWV)'
];

// 渲染表头
function renderHeader() {
  thead.innerHTML = '<tr>' + fixedHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
}

// 渲染表格
function renderPage() {
  tbody.innerHTML = '';
  const totalPages = Math.ceil(displayedData.length / rowsPerPage);
  const start = (currentPage - 1) * rowsPerPage;
  const end = Math.min(start + rowsPerPage, displayedData.length);

  for (let i = start; i < end; i++) {
    const row = displayedData[i];
    const rowCells = [
      i + 1,      // 行号
      '', '', ''  // 前三列空白 year/doy/hour
    ].concat(row);
    while (rowCells.length < fixedHeaders.length) rowCells.push('');
    tbody.insertAdjacentHTML('beforeend', '<tr>' + rowCells.map(v=>`<td>${v}</td>`).join('') + '</tr>');
  }

  pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页 (${displayedData.length} 行已加载 / 共 ${fullData.length} 行)`;
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage === totalPages;
}

// 解析 CSV
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  fullData = lines.map(l => l.split(/[\s,]+/));

  // 先显示前200行
  displayedData = fullData.slice(0, rowsPerPage);
  currentPage = 1;
  renderHeader();
  renderPage();

  // 后续分批加载剩余数据，避免首次等待
  if (fullData.length > rowsPerPage) {
    let index = rowsPerPage;
    const batchSize = 500; // 每批加载500行
    const interval = setInterval(() => {
      const nextIndex = Math.min(index + batchSize, fullData.length);
      displayedData = displayedData.concat(fullData.slice(index, nextIndex));
      index = nextIndex;
      renderPage();
      if (index >= fullData.length) clearInterval(interval);
    }, 50); // 每50ms加载一批
  }
}

// 文件选择
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => parseCSV(ev.target.result);
  reader.readAsText(file);
});

// 默认 CSV
const defaultCSVUrl = 'https://raw.githubusercontent.com/SGG-hub/test-01/main/data.csv';
loadDefaultBtn.addEventListener('click', () => {
  fetch(defaultCSVUrl)
    .then(res => res.ok ? res.text() : Promise.reject('无法加载默认 CSV'))
    .then(text => parseCSV(text))
    .catch(err => console.error(err));
});

// 分页按钮
prevBtn.addEventListener('click', () => { if(currentPage>1){currentPage--; renderPage(); }});
nextBtn.addEventListener('click', () => { if(currentPage<Math.ceil(displayedData.length/rowsPerPage)){currentPage++; renderPage(); }});

// 页面加载时先显示库数据前200行
loadDefaultBtn.click();
</script>

</body>
</html>